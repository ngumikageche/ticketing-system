openapi: 3.0.3
info:
  title: Support Ticketing System API
  version: 1.0.0
  description: |
    Comprehensive API for a support ticketing system with users, tickets, comments, attachments, knowledge base, notifications, and real-time messaging with threaded conversations.

    ## Key Features

    - **Multi-channel Messaging**: Support for direct messages, group conversations, and ticket-based discussions
    - **Threaded Replies**: Full support for nested message replies in both conversations and ticket comments
    - **Real-time Notifications**: Dual-channel notifications via webhooks and WebSocket/Socket.IO
    - **Comprehensive Ticketing**: Full lifecycle management of support tickets with status tracking
    - **Knowledge Base**: Article management with tagging and search capabilities
    - **File Attachments**: Support for attaching files to tickets and messages
    - **User Management**: Role-based access control and user administration

    ## Real-time Notifications & Webhooks

    The API supports comprehensive real-time notifications through **dual channels**:

    ### Webhooks (HTTP-based)
    - External integrations and reliable delivery
    - Configurable per user with retry logic
    - Includes full entity data for UI updates

    ### WebSockets/Socket.IO (Real-time)
    - Instant bidirectional communication
    - Room-based messaging for targeted updates
    - Automatic UI synchronization without polling

    **Socket.IO Events:**
    - `notification` - All notifications (with full payload)
    - `ticket.update` - Ticket-related updates
    - `comment.update` - Comment-related updates  
    - `message.update` - Message-related updates
    - `conversation.update` - Conversation-related updates
    - `user.update` - User-related updates
    - `kb.update` - Knowledge base updates
    - `attachment.update` - Attachment updates

    ### Supported Events
    - **Comments**: Created, updated, deleted
    - **Messages**: Created, deleted
    - **Conversations**: Created
    - **Tickets**: Created, updated, deleted
    - **Users**: Created, deactivated
    - **Knowledge Base**: Articles created
    - **Attachments**: Added, updated, deleted

    ### Setting up Webhooks

    1. **Configure Webhook URL**: Users can set a webhook URL via `PUT /api/users/me/webhook`
    2. **Receive Notifications**: When relevant events occur, HTTP POST requests are sent to the configured URL
    3. **Internal Webhooks**: For same-app integrations, use relative URLs like `/api/notifications/webhooks/notifications`

    ### Webhook Payload

    ```json
    {
      "event": "notification.created",
      "notification": {
        "id": "uuid",
        "type": "comment_on_ticket",
        "message": "New comment on your ticket 'Subject' by Author",
        "related_id": "entity-uuid",
        "related_type": "comment|ticket|user|kb_article|attachment",
        "created_at": "2025-11-17T12:00:00Z"
      },
      "data": {
        // Optional: Full entity data for real-time UI updates
        // Allows frontend to update specific items without refetching lists
        "id": "entity-uuid",
        "field1": "value1",
        "field2": "value2"
        // ... complete entity fields
      }
    }
    ```

    ### Testing Webhooks

    Use `POST /api/notifications/webhooks/test` to send a test webhook to your configured URL.
servers:
  - url: http://localhost:5000
paths:
  /api/auth/signup:
    post:
      summary: Sign up for a new account
      tags: [auth]
      description: |
        Create a new user account. Requires answering all security questions correctly.
        - **Admin role**: Assigned if all security questions are answered correctly
        - **Customer role**: Assigned if at least one security question is answered correctly
        - **Rejected**: If no security questions are answered correctly
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, name, security_answers]
              properties:
                email:
                  type: string
                  format: email
                  description: User's email address
                password:
                  type: string
                  minLength: 8
                  description: Password (minimum 8 characters)
                name:
                  type: string
                  description: User's full name
                security_answers:
                  type: array
                  minItems: 2
                  maxItems: 2
                  items:
                    type: string
                  description: Answers to all security questions in order (case-insensitive). Must provide answers for both questions.
                  example: ["2023", "muguku business center"]
      responses:
        '201':
          description: Account created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  access_token:
                    type: string
                    description: JWT access token for authentication
        '200':
          description: Existing soft-deleted account was reactivated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Invalid input data
        '409':
          description: User already exists

  /api/auth/security-questions:
    get:
      summary: Get available security questions for signup
      tags: [auth]
      responses:
        '200':
          description: List of security questions
          content:
            application/json:
              schema:
                type: object
                properties:
                  questions:
                    type: array
                    items:
                      type: string
                    example: ["Which year was NexTek started?", "What building is the company located at?"]

  /api/auth/login:
    post:
      summary: Log in and obtain a JWT access token
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Ok
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
  /api/auth/me:
    get:
      summary: Get current user details
      tags: [auth]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Invalid or missing token
        '404':
          description: User not found
  /api/users/:
    get:
      summary: List all users
      tags: [users]
      responses:
        '200':
          description: A list of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    post:
      summary: Create a user (admin only)
      tags: [users]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewUser'
      responses:
        '200':
          description: Existing soft-deleted user was reactivated and updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '201':
          description: New user created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
  /api/users/{id_}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      tags: [users]
      responses:
        '200':
          description: A user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    put:
      tags: [users]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    delete:
      summary: Disable user (soft delete)
      tags: [users]
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Disabled

  /api/users/me/webhook:
    get:
      summary: Get current user's webhook URL
      tags: [users]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current webhook URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  webhook_url:
                    type: string
                    nullable: true
    put:
      summary: Update current user's webhook URL
      tags: [users]
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                webhook_url:
                  type: string
                  description: Webhook URL for real-time notifications. Can be an external URL or internal path starting with /
      responses:
        '200':
          description: Updated webhook URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  webhook_url:
                    type: string
                    nullable: true

  /api/tickets/:
    get:
      tags: [tickets]
      summary: List tickets
      responses:
        '200':
          description: A list of tickets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Ticket'
    post:
      tags: [tickets]
      summary: Create a new ticket
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewTicket'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ticket'

  /api/tickets/{id_}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      tags: [tickets]
      summary: Get ticket details
      responses:
        '200':
          description: A ticket
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ticket'
    put:
      tags: [tickets]
      summary: Update ticket
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketUpdate'
      responses:
        '200':
          description: Updated ticket
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ticket'
    delete:
      tags: [tickets]
      summary: Delete ticket (soft delete)
      responses:
        '204':
          description: Deleted

  /api/tickets/{ticket_id}/messages:
    parameters:
      - name: ticket_id
        in: path
        required: true
        schema:
          type: string
        description: Ticket ID
    get:
      tags: [tickets]
      summary: Get messages for a ticket
      description: Retrieve all messages (comments) for a specific ticket, supporting threaded replies
      responses:
        '200':
          description: List of ticket messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Comment'
    post:
      tags: [tickets]
      summary: Send message to ticket
      description: Create a new message on a ticket, optionally as a reply to another message
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewComment'
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'

  /api/comments/:
    get:
      tags: [comments]
      summary: List all comments
      responses:
        '200':
          description: List of comments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Comment'
    post:
      tags: [comments]
      summary: Create a new comment
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewComment'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
  /api/comments/{id_}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      tags: [comments]
      summary: Get comment details
      responses:
        '200':
          description: A comment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
    patch:
      tags: [comments]
      summary: Update comment
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentUpdate'
      responses:
        '200':
          description: Updated comment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
    delete:
      tags: [comments]
      summary: Delete comment (soft delete)
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Deleted

  /api/notifications/:
    get:
      tags: [notifications]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of notifications for the current user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Notification'
  /api/notifications/{id_}/read:
    parameters:
      - $ref: '#/components/parameters/id'
    post:
      tags: [notifications]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Marked as read
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Notification'

  /api/notifications/webhooks/notifications:
    post:
      summary: Receive webhook notifications
      tags: [webhooks]
      description: |
        Endpoint for receiving webhook notifications. This can be used as a target
        for user-configured webhook URLs to receive real-time notification updates.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookPayload'
      responses:
        '200':
          description: Webhook received successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: received

  /api/notifications/webhooks/test:
    post:
      summary: Test webhook configuration
      tags: [webhooks]
      security:
        - bearerAuth: []
      description: Send a test webhook to the current user's configured webhook URL
      responses:
        '200':
          description: Test webhook sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: test webhook sent
        '400':
          description: No webhook URL configured
        '500':
          description: Failed to send test webhook

  /api/attachments/:
    get:
      tags: [attachments]
      summary: List all attachments
      responses:
        '200':
          description: List of attachments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Attachment'
    post:
      tags: [attachments]
      summary: Create a new attachment
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewAttachment'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Attachment'
  /api/attachments/{id_}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      tags: [attachments]
      summary: Get attachment details
      responses:
        '200':
          description: An attachment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Attachment'
    put:
      tags: [attachments]
      summary: Update attachment
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttachmentUpdate'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Attachment'
    delete:
      tags: [attachments]
      summary: Delete attachment (soft delete)
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Deleted

  /api/kb/articles:
    get:
      tags: [kb]
      summary: List knowledge base articles
      responses:
        '200':
          description: List of articles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/KnowledgeBaseArticle'
    post:
      tags: [kb]
      summary: Create a new KB article
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewArticle'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KnowledgeBaseArticle'
  /api/kb/articles/{id_}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      tags: [kb]
      summary: Get KB article details
      responses:
        '200':
          description: An article
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KnowledgeBaseArticle'
    patch:
      tags: [kb]
      summary: Update KB article
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArticleUpdate'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KnowledgeBaseArticle'
    delete:
      tags: [kb]
      summary: Delete KB article (soft delete)
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Deleted

  /api/kb/tags:
    get:
      tags: [kb]
      summary: List all tags
      responses:
        '200':
          description: List of tags
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tag'
    post:
      tags: [kb]
      summary: Create a new tag
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewTag'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
  /api/kb/tags/{id_}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      tags: [kb]
      summary: Get tag details
      responses:
        '200':
          description: A tag
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
    patch:
      tags: [kb]
      summary: Update tag
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TagUpdate'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
    delete:
      tags: [kb]
      summary: Delete tag (soft delete)
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Deleted

  /api/dashboard/:
    get:
      summary: Get dashboard overview with key metrics and charts
      tags: [dashboard]
      responses:
        '200':
          description: Dashboard data including totals, breakdowns, and trends
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dashboard'
  /api/dashboard/reports/tickets-by-status:
    get:
      summary: Detailed ticket status breakdown with resolution rates
      tags: [dashboard]
      responses:
        '200':
          description: Status breakdown data
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StatusBreakdown'
  /api/dashboard/reports/agent-performance:
    get:
      summary: Agent performance metrics
      tags: [dashboard]
      responses:
        '200':
          description: Agent performance data
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AgentPerformance'
  /api/conversations/:
    get:
      tags: [conversations]
      summary: List conversations
      responses:
        '200':
          description: List of conversations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Conversation'
    post:
      tags: [conversations]
      summary: Create a conversation
      description: |
        Create a new conversation. Requirements vary by type:
        - **direct**: Requires recipient_id. If a direct conversation already exists between these users, returns the existing conversation instead of creating a new one.
        - **group**: Requires participants array and optional title
        - **ticket**: Requires ticket_id (auto-creates conversation for ticket participants)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewConversation'
      responses:
        '200':
          description: Existing direct conversation returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '201':
          description: New conversation created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'

  /api/conversations/{id_}:
    parameters:
      - $ref: '#/components/parameters/id'
    delete:
      tags: [conversations]
      summary: Delete conversation
      description: Delete a conversation (participants only)
      responses:
        '204':
          description: Conversation deleted

  /api/conversations/{id_}:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      tags: [conversations]
      summary: Get conversation details
      description: Get details of a specific conversation. Direct conversations are only accessible to participants.
      responses:
        '200':
          description: Conversation details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '403':
          description: Not authorized to access this direct conversation
  /api/conversations/{id_}/messages:
    parameters:
      - $ref: '#/components/parameters/id'
    get:
      tags: [conversations]
      summary: Get messages in conversation
      description: Retrieve all messages in a conversation, supporting threaded replies
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Message'
    post:
      tags: [conversations]
      summary: Send message to conversation
      description: Create a new message in a conversation, optionally as a reply to another message
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewMessage'
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
  /api/conversations/{id_}/participants:
    parameters:
      - $ref: '#/components/parameters/id'
    post:
      tags: [conversations]
      summary: Add participant to conversation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id: { type: string }
      responses:
        '201':
          description: Participant added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationParticipant'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    id:
      name: id_
      in: path
      required: true
      schema:
        type: string

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
        webhook_url:
          type: string
          nullable: true
          description: URL for receiving real-time webhook notifications
        security_question:
          type: string
          nullable: true
          description: Security question for account recovery
        is_active:
          type: boolean
    NewUser:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
        name:
          type: string
        role:
          type: string
    UserUpdate:
      type: object
      properties:
        email: { type: string }
        name: { type: string }
        role: { type: string }

    Ticket:
      type: object
      properties:
        id: { type: string }
        ticket_id: { type: string }
        subject: { type: string }
        description: { type: string }
        status: { type: string }
        priority: { type: string }
        status_changed_at: { type: string, format: date-time, nullable: true }
        requester_id: { type: string, nullable: true }
        requester_name: { type: string, nullable: true }
        assignee_id: { type: string, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
    NewTicket:
      type: object
      required: [subject]
      properties:
        ticket_id: { type: string }
        subject: { type: string }
        description: { type: string }
        status: { type: string }
        priority: { type: string }
        requester_id: { type: string }
        requester_name: { type: string }
        assignee_id: { type: string }
      oneOf:
        - required: [requester_id]
        - required: [requester_name]
    TicketUpdate:
      type: object
      properties:
        subject: { type: string }
        description: { type: string }
        status: { type: string }
        priority: { type: string }
        assignee_id: { type: string }

    Comment:
      type: object
      properties:
        id: { type: string }
        content: { type: string }
        ticket_id: { type: string }
        author_id: { type: string }
        parent_message_id: { type: string, nullable: true, description: "ID of parent message for threaded replies" }
    NewComment:
      type: object
      required: [content, ticket_id, author_id]
      properties:
        content: { type: string }
        ticket_id: { type: string }
        author_id: { type: string }
        parent_message_id: { type: string, description: "ID of parent message for threaded replies" }
    CommentUpdate:
      type: object
      properties:
        content: { type: string }

    Message:
      type: object
      properties:
        id: { type: string }
        conversation_id: { type: string }
        sender_id: { type: string }
        content: { type: string }
        message_type: { type: string, enum: [text, file, system], default: text }
        parent_message_id: { type: string, nullable: true, description: "ID of parent message for threaded replies" }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
    NewMessage:
      type: object
      required: [content, sender_id]
      properties:
        content: { type: string }
        sender_id: { type: string }
        message_type: { type: string, enum: [text, file, system], default: text }
        parent_message_id: { type: string, description: "ID of parent message for threaded replies" }

    Conversation:
      type: object
      properties:
        id: { type: string }
        type: { type: string, enum: [ticket, direct, group] }
        title: { type: string }
        ticket_id: { type: string }
        created_by_id: { type: string }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
    NewConversation:
      type: object
      required: [type, created_by_id]
      properties:
        type: { type: string, enum: [ticket, direct, group] }
        title: { type: string }
        ticket_id: { type: string }
        created_by_id: { type: string }
        recipient_id: { type: string, description: "Required for direct conversations" }
        participants: { type: array, items: { type: string }, description: "Required for group conversations" }

    ConversationParticipant:
      type: object
      properties:
        id: { type: string }
        conversation_id: { type: string }
        user_id: { type: string }
        role: { type: string, enum: [admin, member], default: member }
        created_at: { type: string, format: date-time }

    Notification:
      type: object
      properties:
        id: { type: string }
        user_id: { type: string }
        type: 
          type: string
          enum: [
            comment_on_ticket, reply_to_comment, new_ticket, 
            ticket_updated, ticket_deleted, comment_updated, comment_deleted,
            user_created, user_deactivated, ticket_assigned, kb_article_created,
            attachment_added, attachment_updated, attachment_deleted,
            message_on_ticket, message_deleted, message_on_conversation,
            webhook_test
          ]
        message: { type: string }
        related_id: { type: string, nullable: true }
        related_type: 
          type: string
          nullable: true
          enum: [comment, ticket, user, kb_article, attachment, message]
        is_read: { type: boolean }
        created_at: { type: string, format: date-time }

    Attachment:
      type: object
      properties:
        id: { type: string }
        filename: { type: string }
        url: { type: string }
        type: { type: string }
        size: { type: integer }
        ticket_id: { type: string }
    NewAttachment:
      type: object
      required: [filename, url, ticket_id, uploaded_by]
      properties:
        filename: { type: string }
        url: { type: string }
        type: { type: string }
        size: { type: integer }
        ticket_id: { type: string }
        uploaded_by: { type: string }
    AttachmentUpdate:
      type: object
      properties:
        filename: { type: string }
        url: { type: string }
        type: { type: string }
        size: { type: integer }

    KnowledgeBaseArticle:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        content: { type: string }
        author_id: { type: string }
        views: { type: integer }
        is_public: { type: boolean }
        tags: 
          type: array
          items:
            $ref: '#/components/schemas/Tag'
    NewArticle:
      type: object
      required: [title, content, author_id]
      properties:
        title: { type: string }
        content: { type: string }
        author_id: { type: string }
        is_public: { type: boolean }
        tags:
          type: array
          items:
            type: string

    Tag:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        color: { type: string }
    NewTag:
      type: object
      required: [name]
      properties:
        name: { type: string }
        color: { type: string }
    TagUpdate:
      type: object
      properties:
        name: { type: string }
        color: { type: string }

    Dashboard:
      type: object
      properties:
        totalTickets: { type: integer }
        resolvedTickets: { type: integer }
        avgResponse: { type: string }
        statusBreakdown:
          type: object
          additionalProperties:
            type: integer
        priorityBreakdown:
          type: object
          additionalProperties:
            type: integer
        monthlyData:
          type: array
          items:
            type: object
            properties:
              month: { type: string }
              tickets: { type: integer }
        recentActivity:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              ticket_id: { type: string }
              subject: { type: string }
              status: { type: string }
              updated_at: { type: string, format: date-time }

    StatusBreakdown:
      type: object
      properties:
        status: { type: string }
        count: { type: integer }
        resolutionRate: { type: number }

    AgentPerformance:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        assignedTickets: { type: integer }
        resolvedTickets: { type: integer }
        resolutionRate: { type: number }

    TicketTrend:
      type: object
      properties:
        date: { type: string, format: date }
        created: { type: integer }
        resolved: { type: integer }

    WebhookPayload:
      type: object
      required: [event, notification]
      properties:
        event:
          type: string
          example: notification.created
        notification:
          type: object
          properties:
            id:
              type: string
            type:
              type: string
              enum: [
                comment_on_ticket, reply_to_comment, new_ticket,
                ticket_updated, ticket_deleted, comment_updated, comment_deleted,
                user_created, user_deactivated, ticket_assigned, kb_article_created,
                attachment_added, attachment_updated, attachment_deleted,
                message_on_ticket, message_deleted, message_on_conversation,
                webhook_test
              ]
            message:
              type: string
            related_id:
              type: string
              nullable: true
            related_type:
              type: string
              nullable: true
              enum: [comment, ticket, user, kb_article, attachment, message]
            created_at:
              type: string
              format: date-time

tags:
  - name: auth
    description: Authentication endpoints
  - name: users
    description: User management endpoints
  - name: tickets
    description: Ticket management endpoints
  - name: comments
    description: Comment and discussion endpoints
  - name: conversations
    description: Chat conversation endpoints
  - name: attachments
    description: File attachment endpoints
  - name: kb
    description: Knowledge base and article endpoints
  - name: notifications
    description: User notification endpoints
  - name: webhooks
    description: Webhook configuration and receiver endpoints
  - name: dashboard
    description: Reporting and analytics endpoints
